<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>QR Clock</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0f0f1a;--bg2:#1a1a2e;--bg3:#16213e;
  --accent:#4f8ef7;--text:#e8eaf6;--muted:#7986cb;
  --radius:10px;
}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;min-height:100vh;padding:0 0 48px}
header{
  background:var(--bg2);padding:14px 18px;
  display:flex;align-items:center;justify-content:space-between;
  border-bottom:1px solid #ffffff10;position:sticky;top:0;z-index:10;
}
header h1{font-size:17px;font-weight:700;letter-spacing:.3px}
#dot{width:8px;height:8px;border-radius:50%;background:#555;transition:background .4s;flex-shrink:0}
#dot.on{background:#66bb6a;box-shadow:0 0 6px #66bb6a88}
.section{margin:16px 14px 0;background:var(--bg2);border-radius:var(--radius);padding:16px;border:1px solid #ffffff08}
.section-title{font-size:10px;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);margin-bottom:13px;font-weight:600}
.modes{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.mode-btn{
  background:var(--bg3);border:1px solid #ffffff0e;border-radius:8px;
  color:var(--muted);padding:11px 4px 9px;font-size:12px;font-weight:500;
  cursor:pointer;transition:all .15s;text-align:center;line-height:1.3;
  -webkit-tap-highlight-color:transparent;
}
.mode-btn:active{transform:scale(.96)}
.mode-btn.active{background:#4f8ef720;border-color:var(--accent);color:var(--text)}
.mode-btn .icon{font-size:22px;display:block;margin-bottom:5px}
.ctrl{margin-bottom:15px}
.ctrl:last-child{margin-bottom:0}
.ctrl-label{display:flex;justify-content:space-between;font-size:13px;color:var(--muted);margin-bottom:8px}
.ctrl-label span{color:var(--text);font-weight:600;min-width:2.5ch;text-align:right}
input[type=range]{
  -webkit-appearance:none;width:100%;height:5px;border-radius:3px;
  background:var(--bg3);outline:none;cursor:pointer;
}
input[type=range]::-webkit-slider-thumb{
  -webkit-appearance:none;width:22px;height:22px;border-radius:50%;
  background:var(--accent);cursor:pointer;border:2px solid var(--bg2);
  box-shadow:0 0 4px #0004;
}
.color-row{display:flex;align-items:center;gap:12px}
input[type=color]{
  -webkit-appearance:none;width:52px;height:52px;border:none;
  border-radius:8px;cursor:pointer;background:none;padding:0;flex-shrink:0;
}
input[type=color]::-webkit-color-swatch-wrapper{padding:0}
input[type=color]::-webkit-color-swatch{border-radius:6px;border:2px solid #ffffff22}
.hex-input{
  flex:1;background:var(--bg3);border:1px solid #ffffff14;border-radius:8px;
  color:var(--text);padding:10px 12px;font-size:14px;font-family:monospace;
  outline:none;min-width:0;
}
.hex-input:focus{border-color:var(--accent)}
.footer{margin:20px 14px 0;text-align:center;font-size:12px;color:var(--muted);line-height:2}
.footer a{color:#e94560;text-decoration:none}
.footer a:active{opacity:.7}
#ip{font-family:monospace;color:var(--text)}
#color-section{display:none}
#anim-section{display:none}
</style>
</head>
<body>

<header>
  <h1>â¬› QR Clock</h1>
  <div id="dot"></div>
</header>

<div class="section">
  <div class="section-title">Mode</div>
  <div class="modes">
    <button class="mode-btn" data-mode="0"><span class="icon">ðŸ“±</span>QR Clock</button>
    <button class="mode-btn" data-mode="1"><span class="icon">ðŸ”²</span>Solid</button>
    <button class="mode-btn" data-mode="2"><span class="icon">ðŸŒˆ</span>Rainbow</button>
    <button class="mode-btn" data-mode="3"><span class="icon">ðŸ”¥</span>Fire</button>
    <button class="mode-btn" data-mode="4"><span class="icon">ðŸ’»</span>Matrix</button>
    <button class="mode-btn" data-mode="5"><span class="icon">ðŸŒŠ</span>Plasma</button>
  </div>
</div>

<div class="section" id="color-section">
  <div class="section-title">Color</div>
  <div class="ctrl">
    <div class="color-row">
      <input type="color" id="color-picker" value="#00c8ff">
      <input type="text" class="hex-input" id="color-hex" maxlength="7" placeholder="#00c8ff" autocomplete="off" spellcheck="false">
    </div>
  </div>
</div>

<div class="section" id="anim-section">
  <div class="section-title">Animation</div>
  <div class="ctrl">
    <div class="ctrl-label">Speed <span id="speed-val">128</span></div>
    <input type="range" id="speed" min="0" max="255" value="128">
  </div>
</div>

<div class="section">
  <div class="section-title">Display</div>
  <div class="ctrl">
    <div class="ctrl-label">Brightness <span id="bright-val">100</span></div>
    <input type="range" id="brightness" min="10" max="255" value="100">
  </div>
</div>

<div class="footer">
  <span id="ip">connectingâ€¦</span><br>
  <a href="/reset-wifi" onclick="return confirmReset()">Reset WiFi credentials</a>
</div>

<script>
let state = { mode:0, r:0, g:200, b:255, speed:128, brightness:100 };
let ws;

function connect() {
  ws = new WebSocket('ws://' + location.host + '/ws');
  ws.onopen  = () => { document.getElementById('dot').className = 'on'; };
  ws.onclose = () => { document.getElementById('dot').className = ''; setTimeout(connect, 2000); };
  ws.onmessage = e => { state = JSON.parse(e.data); render(); };
}

function send(patch) {
  Object.assign(state, patch);
  if (ws && ws.readyState === 1) ws.send(JSON.stringify(state));
}

function rgbHex(r, g, b) {
  return '#' + [r,g,b].map(v => v.toString(16).padStart(2,'0')).join('');
}

function hexRgb(hex) {
  const m = /^#?([0-9a-f]{6})$/i.exec(hex);
  if (!m) return null;
  const n = parseInt(m[1], 16);
  return { r:(n>>16)&255, g:(n>>8)&255, b:n&255 };
}

function render() {
  // mode buttons
  document.querySelectorAll('.mode-btn').forEach(b =>
    b.classList.toggle('active', +b.dataset.mode === state.mode));
  // section visibility
  document.getElementById('color-section').style.display = state.mode === 1 ? 'block' : 'none';
  document.getElementById('anim-section').style.display  = state.mode >= 2 ? 'block' : 'none';
  // sliders
  document.getElementById('speed').value = state.speed;
  document.getElementById('brightness').value = state.brightness;
  document.getElementById('speed-val').textContent = state.speed;
  document.getElementById('bright-val').textContent = state.brightness;
  // color
  const hex = rgbHex(state.r, state.g, state.b);
  document.getElementById('color-picker').value = hex;
  document.getElementById('color-hex').value = hex;
  // ip
  document.getElementById('ip').textContent = location.hostname;
}

// â”€â”€ controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.mode-btn').forEach(b =>
  b.addEventListener('click', () => send({ mode: +b.dataset.mode })));

document.getElementById('color-picker').addEventListener('input', e => {
  const rgb = hexRgb(e.target.value);
  if (!rgb) return;
  document.getElementById('color-hex').value = e.target.value;
  send(rgb);
});

document.getElementById('color-hex').addEventListener('change', e => {
  const rgb = hexRgb(e.target.value);
  if (!rgb) return;
  document.getElementById('color-picker').value = rgbHex(rgb.r, rgb.g, rgb.b);
  send(rgb);
});

document.getElementById('speed').addEventListener('input', e => {
  document.getElementById('speed-val').textContent = e.target.value;
  send({ speed: +e.target.value });
});

document.getElementById('brightness').addEventListener('input', e => {
  document.getElementById('bright-val').textContent = e.target.value;
  send({ brightness: +e.target.value });
});

function confirmReset() {
  if (confirm('Clear saved WiFi credentials?\n\nThe device will reboot into AP setup mode.\nReconnect to "QRClock-Setup" WiFi.')) {
    fetch('/reset-wifi').then(() => alert('Done â€” reconnect to "QRClock-Setup" to set new credentials.'));
  }
  return false;
}

connect();
render();
</script>
</body>
</html>
